:docinfo: shared
:source-highlighter: highlight.js
:toc:

= Brevmal-DSL: Komplett referanse

Dette dokumentet beskriver alle tilgjengelige elementer, funksjoner og operatorer i brevmal-DSL-en.

== Expression-systemet

Expression-systemet er kjernen i dynamisk innhold. Alle verdier fra datamodellen er `Expression<T>` – de evalueres ved brevgenerering, ikke ved kompilering.

=== Tilgang til data

I `outline`-blokken får du tilgang til datamodellen via genererte selectors (fra `@TemplateModelHelpers`):

[source,kotlin]
----
outline {
    // Naviger datamodellen med selectors
    val uforegrad = pesysData.uforegrad
    val virkningsdato = pesysData.virkningFom
}
----

=== Literaler

Konverter vanlige verdier til uttrykk med `.expr()`:

[source,kotlin]
----
val grense = 100.expr()
val flagg = true.expr()
val tekst = "Hei".expr()
----

=== Formatering

[cols="2,2,3"]
|===
|Funksjon |Type |Eksempel resultat

|`format()`
|`Expression<Int>`
|`75` → "75"

|`format()`
|`Expression<Kroner>`
|`Kroner(12345)` → "12 345"

|`format(scale = 2)`
|`Expression<Double>`
|`75.5` → "75,50"

|`format()`
|`Expression<LocalDate>`
|`LocalDate.of(2025,1,1)` → "01.01.2025"

|`format()`
|`Expression<Year>`
|`Year.of(2025)` → "2025"
|===

=== Sammenligningsoperatorer

[source,kotlin]
----
verdi.equalTo(annenVerdi)             // ==
verdi.notEqualTo(annenVerdi)          // !=
verdi.greaterThan(annenVerdi)         // >
verdi.lessThan(annenVerdi)            // <
verdi.greaterThanOrEqual(annenVerdi)  // >=
verdi.lessThanOrEqual(annenVerdi)     // <=
----

=== Logiske operatorer

[source,kotlin]
----
betingelse1 and betingelse2           // OG
betingelse1 or betingelse2            // ELLER
not(betingelse)                       // IKKE
----

Eksempel:
[source,kotlin]
----
showIf(uforegrad.greaterThan(50) and borINorge) {
    paragraph {
        text(bokmal { +"Du har høy uføregrad og bor i Norge." })
    }
}
----

=== Null-håndtering

[source,kotlin]
----
verdi.notNull()                       // Expression<Boolean> – er ikke null?
verdi.isNull()                        // Expression<Boolean> – er null?
verdi.ifNull(standardVerdi)           // Bruk standardverdi hvis null
----

=== Enum-operasjoner

==== isOneOf

Sjekk om en verdi er én av flere enum-verdier:

[source,kotlin]
----
sivilstand.isOneOf(Sivilstand.GIFT, Sivilstand.REGISTRERT_PARTNER)

// Kan brukes i betingelser
showIf(ytelse.isOneOf(KonteringType.AFP_KOMP_TILLEGG, KonteringType.AFP_KRONETILLEGG)) {
    text(bokmal { +"AFP-tillegg" })
}
----

=== Betinget uttrykk

==== ifElse

For inline betinget verdivalg (ikke visning av innhold):

[source,kotlin]
----
val tekst = ifElse(
    erGift,
    "ektefelle".expr(),
    "samboer".expr()
)

// Bruk i tekst
text(
    bokmal {
        +"Inntekten til "
        +ifElse(barnetilleggGjelderFlereBarn, "barna", "barnet")
        +" påvirker utbetalingen."
    }
)
----

IMPORTANT: `ifElse` brukes for å velge mellom *verdier*. For å vise/skjule innhold, bruk `showIf` og `orShow`.

=== Samlingsoperasjoner

[source,kotlin]
----
perioder.size()                       // Antall elementer
perioder.isEmpty()                    // Er tom?
perioder.isNotEmpty()                 // Er ikke tom?
perioder.map { it.beloep }           // Transformer elementer
perioder.filter { it.aktiv }         // Filtrer elementer
----

=== Aritmetiske operasjoner

[source,kotlin]
----
// Kun addisjon og subtraksjon for Int
verdi1 + verdi2                       // Addisjon
verdi1 - verdi2                       // Subtraksjon

// Strengsammenslåing
streng1 + streng2
----

NOTE: Multiplikasjon og divisjon er bevisst utelatt for å unngå forretningslogikk i maler.

== Dokumentelementer

=== Tekst

==== text() - Statisk tekst

Brukes når du kun har ren tekst uten variabler:

[source,kotlin]
----
paragraph {
    text(
        bokmal { +"Du må sende oss egenerklæring om pleie- og omsorgsarbeid" },
        nynorsk { +"Du må sende oss eigenmelding om pleie- og omsorgsarbeid" },
        english { +"Personal declaration about the circumstances of care" }
    )
}
----

Med skrifttype:
[source,kotlin]
----
text(
    bokmal { +"Viktig informasjon" },
    nynorsk { +"Viktig informasjon" },
    FontType.BOLD  // PLAIN, BOLD, ITALIC
)
----

==== textExpr() - Tekst med variabler (eldre syntaks)

[source,kotlin]
----
textExpr(
    bokmal { +"Du får utbetalt " + beloep.format() + " kroner per måned." },
    nynorsk { +"Du får utbetalt " + beloep.format() + " kroner per månad." },
)
----

==== text { } - Moderne syntaks med tekst-builder

Den anbefalte måten å blande tekst og variabler:

[source,kotlin]
----
text(
    bokmal {
        +"Du får "
        +beloep.format()
        +" kroner per måned."
    },
    nynorsk {
        +"Du får "
        +beloep.format()
        +" kroner per månad."
    }
)
----

==== eval() - Inline uttrykk

Brukes for å sette inn et uttrykk direkte uten omsluttende tekst:

[source,kotlin]
----
paragraph {
    eval(beloep.format())
}

// I tabell
cell {
    eval(periode.fom.format())
}
----

==== newline() - Linjeskift

[source,kotlin]
----
text(bokmal { +"Første linje" })
newline()
text(bokmal { +"Andre linje" })
----

==== Sitattegn med quoted()

Legger til språkriktige anførselstegn:

[source,kotlin]
----
text(
    bokmal {
        +"Vi viser til "
        +"folketrygdloven".quoted()
        +"."
    }
)
// Resultat: Vi viser til «folketrygdloven».
----

=== Avsnitt (paragraph)

Avsnitt deler opp innhold med mellomrom:

[source,kotlin]
----
outline {
    paragraph {
        text(bokmal { +"Dette er første avsnitt." })
    }

    paragraph {
        text(bokmal { +"Dette er andre avsnitt, med mellomrom over." })
    }
}
----

=== Overskrifter

==== title1 - Hovedoverskrift

[source,kotlin]
----
outline {
    title1 {
        text(
            bokmal { +"Vedtak om uføretrygd" },
            nynorsk { +"Vedtak om uføretrygd" },
        )
    }
}
----

==== title2 - Underoverskrift

[source,kotlin]
----
title2 {
    text(
        bokmal { +"Slik beregner vi uføretrygden din" },
        nynorsk { +"Slik reknar vi ut uføretrygda di" },
    )
}
----

==== title3 - Nivå 3 overskrift

Bruk sparsomt - vanligvis holder title1 og title2.

[source,kotlin]
----
title3 {
    text(bokmal { +"Detaljer" })
}
----

=== Lister

Punktlister defineres med `list` og `item`:

[source,kotlin]
----
paragraph {
    text(bokmal { +"For å ha rett til ytelsen må du:" })

    list {
        item {
            text(bokmal { +"Være mellom 18 og 67 år" })
        }
        item {
            text(bokmal { +"Ha vært medlem av folketrygden" })
        }
        item {
            text(bokmal { +"Ha redusert inntektsevne" })
        }
    }
}
----

Med betinget logikk:
[source,kotlin]
----
list {
    item {
        text(bokmal { +"Dette vises alltid" })
    }

    showIf(harBarnetillegg) {
        item {
            text(bokmal { +"Dette vises kun med barnetillegg" })
        }
    }

    forEach(barn) { barn ->
        item {
            text(bokmal { +"Barn: " + barn.navn })
        }
    }
}
----

=== Tabeller

Tabeller må alltid ha en kolonne-heading, og celler kan ikke inneholde lister, tabeller eller avsnitt.

==== Grunnleggende tabell

[source,kotlin]
----
paragraph {
    table(
        header = {
            column {
                text(bokmal { +"Måned" }, FontType.BOLD)
            }
            column(alignment = ColumnAlignment.RIGHT) {
                text(bokmal { +"Beløp" }, FontType.BOLD)
            }
        }
    ) {
        row {
            cell { text(bokmal { +"Januar" }) }
            cell { text(bokmal { +"15 000 kr" }) }
        }
        row {
            cell { text(bokmal { +"Februar" }) }
            cell { text(bokmal { +"15 000 kr" }) }
        }
    }
}
----

==== Kolonneegenskaper

Kolonner støtter følgende egenskaper:

[source,kotlin]
----
column(
    columnSpan = 2,                      // Forholdstall for bredde (default: 1)
    alignment = ColumnAlignment.RIGHT    // LEFT eller RIGHT (default: LEFT)
) {
    text(...)
}
----

TIP: Bruk høyrejustering (`RIGHT`) for tallverdier for best utseende.

==== Dynamiske rader med forEach

[source,kotlin]
----
table(
    header = {
        column { text(bokmal { +"Periode" }) }
        column(alignment = ColumnAlignment.RIGHT) { text(bokmal { +"Stønad" }) }
        column(alignment = ColumnAlignment.RIGHT) { text(bokmal { +"Totalt" }) }
    }
) {
    forEach(utbetalingsperioder) { periode ->
        row {
            cell { eval(periode.maaned.format()) }
            cell { eval(periode.stonad.format()) }
            cell { eval(periode.totalt.format()) }
        }
    }
}
----

==== Betinget innhold i tabeller

[source,kotlin]
----
table(...) {
    // Betinget rad
    showIf(harEkstraRad) {
        row {
            cell { text(bokmal { +"Ekstra" }) }
            cell { text(bokmal { +"1000" }) }
        }
    }

    // Betinget celle
    row {
        cell { text(bokmal { +"Januar" }) }
        showIf(visSkattekolonne) {
            cell { eval(skatt.format()) }
        }
        cell { eval(totalt.format()) }
    }
}
----

IMPORTANT: Antall celler i hver rad må matche antall kolonner, ellers vil malen feile ved oppstart.

=== Skjemafelt (kun redigerbare brev)

==== fritekst() - Enkel fritekst

[source,kotlin]
----
text(
    bokmal {
        +"Vi mottok søknaden din "
        +fritekst("dato")
        +"."
    }
)
----

==== formText - Fritektsfelt med størrelse

[source,kotlin]
----
paragraph {
    formText(size = Form.Text.Size.LONG) {
        text(
            bokmal { +"Beskriv situasjonen:" },
            nynorsk { +"Beskriv situasjonen:" }
        )
    }
}
----

Størrelser: `SHORT`, `MEDIUM`, `LONG`

==== formChoice - Flervalgsfelt

[source,kotlin]
----
paragraph {
    formChoice {
        text(
            bokmal { +"Velg alternativ:" },
            nynorsk { +"Vel alternativ:" }
        )
    }
}
----

== Kontrollstrukturer

=== showIf - Betinget visning

Vis innhold kun dersom en betingelse er oppfylt:

[source,kotlin]
----
showIf(harBarnetillegg) {
    paragraph {
        text(bokmal { +"Du er innvilget barnetillegg." })
    }
}
----

=== showIf ... orShow - If/else

[source,kotlin]
----
showIf(borINorge) {
    paragraph {
        text(bokmal { +"Uføretrygden utbetales den 20. hver måned." })
    }
}.orShow {
    paragraph {
        text(bokmal { +"Utbetalingen til utenlandsk konto kan bli forsinket." })
    }
}
----

=== showIf ... orShowIf - Kjeding av betingelser

For flere gjensidig utelukkende betingelser:

[source,kotlin]
----
showIf(ytelse.equalTo(KonteringType.AFP_KOMP_TILLEGG)) {
    text(bokmal { +"AFP kompensasjonstillegg" })
}.orShowIf(ytelse.equalTo(KonteringType.AFP_KRONETILLEGG)) {
    text(bokmal { +"AFP kronetillegg" })
}.orShowIf(ytelse.equalTo(KonteringType.GJENLEVENDE_TILLEGG)) {
    text(bokmal { +"Gjenlevendetillegg" })
}.orShow {
    text(bokmal { +"Annen ytelse" })
}
----

=== ifNotNull - Null-sikker visning

Vis innhold kun dersom en nullable verdi finnes:

[source,kotlin]
----
ifNotNull(avtaleland) { land ->
    paragraph {
        text(
            bokmal {
                +"Vedtaket er gjort etter trygdeavtalen med "
                +land
                +"."
            }
        )
    }
}
----

==== Flere nullable verdier

[source,kotlin]
----
ifNotNull(trygdetidfom, trygdetidtom) { fom, tom ->
    paragraph {
        text(
            bokmal {
                +"Du har vært medlem fra "
                +fom.format()
                +" til "
                +tom.format()
                +"."
            }
        )
    }
}
----

==== Med fallback

[source,kotlin]
----
ifNotNull(spesifikkVerdi) { verdi ->
    text(bokmal { +"Verdien er: " + verdi })
}.orIfNotNull(alternativVerdi) { alt ->
    text(bokmal { +"Alternativ: " + alt })
}.orShow {
    text(bokmal { +"Ingen verdi funnet" })
}
----

=== forEach - Iterasjon

Iterer over en samling:

[source,kotlin]
----
forEach(perioder) { periode ->
    paragraph {
        text(
            bokmal {
                +"Periode: "
                +periode.fom.format()
                +" - "
                +periode.tom.format()
            }
        )
    }
}
----

==== forEach i tabeller

[source,kotlin]
----
table(
    header = {
        column { text(bokmal { +"Måned" }) }
        column(alignment = ColumnAlignment.RIGHT) { text(bokmal { +"Beløp" }) }
    }
) {
    forEach(utbetalinger) { utbetaling ->
        row {
            cell { eval(utbetaling.maaned.format()) }
            cell { eval(utbetaling.beloep.format()) }
        }
    }
}
----

==== forEach med betinget logikk

[source,kotlin]
----
forEach(tilbakekrevingsperioder) { periode ->
    showIf(periode.beloep.greaterThan(0)) {
        row {
            cell { eval(periode.maaned.format()) }
            cell { eval(periode.beloep.format()) }
        }
    }
}
----

=== Nøsting av kontrollstrukturer

Kontrollstrukturer kan nøstes fritt:

[source,kotlin]
----
showIf(harYrkesskade) {
    title2 {
        text(bokmal { +"Informasjon om yrkesskade" })
    }

    showIf(yrkesskadegrad.equalTo(uforegrad)) {
        paragraph {
            text(bokmal { +"Hele uførheten skyldes yrkesskade." })
        }
    }.orShow {
        paragraph {
            text(bokmal { +"Deler av uførheten skyldes yrkesskade." })
        }
    }

    forEach(yrkesskadeperioder) { periode ->
        paragraph {
            text(bokmal { +"Periode: " + periode.aar.format() })
        }
    }
}
----

== Scope-oversikt

Hvilke elementer som er tilgjengelige avhenger av hvilket scope du er i:

[cols="2,3,4"]
|===
|Scope |Brukes i |Tilgjengelige elementer

|`TemplateRootScope`
|Toppnivå i template
|`title { }`, `outline { }`, `includeAttachment(...)`

|`OutlineScope`
|Inne i `outline { }`
|`paragraph { }`, `title1 { }`, `title2 { }`, `title3 { }`, `showIf`, `ifNotNull`, `forEach`, `includePhrase(...)`

|`ParagraphScope`
|Inne i `paragraph { }`
|`text(...)`, `list { }`, `table(...)`, `formText { }`, `formChoice { }`, `showIf`, `ifNotNull`, `forEach`, `includePhrase(...)`

|`TextOnlyScope`
|Inne i tekst-blokker
|`text(...)`, `eval(...)`, `newline()`, `showIf`, `ifNotNull`, `forEach`

|`ListScope`
|Inne i `list { }`
|`item { }`, `showIf`, `ifNotNull`, `forEach`

|`TableScope`
|Inne i tabell-body
|`row { }`, `showIf`, `ifNotNull`, `forEach`

|`RowScope`
|Inne i `row { }`
|`cell { }`, `showIf`, `ifNotNull`, `forEach`
|===

== Fraser (Phrases)

Se xref:brevbaker-dsl-avansert.adoc#fraser[Avanserte emner: Fraser] for komplett dokumentasjon.

== Vedlegg

Se xref:brevbaker-dsl-avansert.adoc#vedlegg[Avanserte emner: Vedlegg] for komplett dokumentasjon.

