:docinfo: shared
:source-highlighter: highlight.js
:toc:

= Brevmal-DSL: Avanserte emner

Dette dokumentet dekker avanserte konsepter som fraser, vedlegg og komplekse logikkmønstre.

[[fraser]]
== Fraser (Phrases)

Fraser er gjenbrukbare komponenter som kan inkluderes i flere maler. De sikrer konsistent innhold og forenkler vedlikehold.

=== Frase-typer

Det finnes tre typer fraser som kan brukes på ulike nivåer i dokumenthierarkiet:

[cols="2,2,3"]
|===
|Type |Brukes i |Kan inneholde

|`OutlinePhrase`
|`OutlineScope`
|`paragraph`, `title1-3`, kontrollstrukturer

|`ParagraphPhrase`
|`ParagraphScope`
|`text`, `list`, `table`, kontrollstrukturer

|`TextOnlyPhrase`
|`TextOnlyScope`
|`text`, `eval`, `newline`, kontrollstrukturer
|===

=== OutlinePhrase - Fraser med avsnitt og overskrifter

Brukes for større innholdsseksjoner:

[source,kotlin]
----
object RettTilAKlage : OutlinePhrase<LangBokmalNynorskEnglish>() {
    override fun OutlineOnlyScope<LangBokmalNynorskEnglish, Unit>.template() {
        title1 {
            text(
                bokmal { +"Du har rett til å klage" },
                nynorsk { +"Du har rett til å klage" },
                english { +"You have the right to appeal" },
            )
        }

        paragraph {
            text(
                bokmal { +"Du kan klage på dette vedtaket innen 6 uker fra du mottok det." },
                nynorsk { +"Du kan klage på dette vedtaket innan 6 veker frå du fekk det." },
                english { +"You may appeal this decision within 6 weeks of receiving it." },
            )
        }

        paragraph {
            text(
                bokmal { +"Klagen sender du til NAV Familie- og pensjonsytelser." },
                nynorsk { +"Klaga sender du til NAV Familie- og pensjonsytingar." },
                english { +"Send your appeal to NAV Family and Pension Benefits." },
            )
        }
    }
}
----

Bruk i mal:

[source,kotlin]
----
outline {
    // ... brevinnhold ...

    includePhrase(RettTilAKlage)
}
----

=== ParagraphPhrase - Fraser med lister og tabeller

Brukes inne i avsnitt:

[source,kotlin]
----
data class MeldepliktListe(
    val inkluderInntekt: Expression<Boolean>,
    val inkluderSivilstand: Expression<Boolean>,
    val inkluderUtland: Expression<Boolean>
) : ParagraphPhrase<LangBokmalNynorskEnglish>() {
    override fun ParagraphOnlyScope<LangBokmalNynorskEnglish, Unit>.template() {
        text(
            bokmal { +"Du har plikt til å melde fra om:" },
            nynorsk { +"Du har plikt til å melde frå om:" },
            english { +"You must report:" },
        )

        list {
            showIf(inkluderInntekt) {
                item {
                    text(
                        bokmal { +"Endringer i inntekt" },
                        nynorsk { +"Endringar i inntekt" },
                        english { +"Changes in income" },
                    )
                }
            }

            showIf(inkluderSivilstand) {
                item {
                    text(
                        bokmal { +"Endringer i sivilstand" },
                        nynorsk { +"Endringar i sivilstand" },
                        english { +"Changes in marital status" },
                    )
                }
            }

            showIf(inkluderUtland) {
                item {
                    text(
                        bokmal { +"Flytting til utlandet" },
                        nynorsk { +"Flytting til utlandet" },
                        english { +"Moving abroad" },
                    )
                }
            }
        }
    }
}
----

Bruk i mal:

[source,kotlin]
----
paragraph {
    includePhrase(MeldepliktListe(
        inkluderInntekt = true.expr(),
        inkluderSivilstand = harEktefelle,
        inkluderUtland = true.expr()
    ))
}
----

=== TextOnlyPhrase - Fraser kun med tekst

Brukes for inline tekst-fragmenter:

[source,kotlin]
----
data class BeloepMedEnhet(
    val beloep: Expression<Kroner>
) : TextOnlyPhrase<LangBokmalNynorskEnglish>() {
    override fun TextOnlyScope<LangBokmalNynorskEnglish, Unit>.template() {
        text(
            bokmal { +beloep.format() + " kroner" },
            nynorsk { +beloep.format() + " kroner" },
            english { +beloep.format() + " kroner" },
        )
    }
}
----

Bruk i mal:

[source,kotlin]
----
text(
    bokmal {
        +"Du får utbetalt "
        includePhrase(BeloepMedEnhet(maanedligBeloep))
        +" per måned."
    }
)
----

=== Parametriserte fraser

Fraser kan ta inn parametere for å være fleksible:

[source,kotlin]
----
data class BeregningsDetaljer(
    val harFlerePerioder: Expression<Boolean>,
    val perioder: Expression<Collection<BeregningsPeriode>>,
    val gjeldendePeriode: Expression<BeregningsPeriode>,
) : OutlinePhrase<LangBokmalNynorskEnglish>() {
    override fun OutlineOnlyScope<LangBokmalNynorskEnglish, Unit>.template() {
        title1 {
            text(
                bokmal { +"Slik beregner vi uføretrygden din" },
                nynorsk { +"Slik reknar vi ut uføretrygda di" },
                english { +"How we calculate your disability benefit" },
            )
        }

        // Vis alltid gjeldende periode
        includePhrase(TabellGjeldendePeriode(gjeldendePeriode))

        // Vis historiske perioder hvis de finnes
        showIf(harFlerePerioder) {
            paragraph {
                text(
                    bokmal { +"Du har flere beregningsperioder:" },
                    nynorsk { +"Du har fleire utrekningsperiodar:" },
                    english { +"You have multiple calculation periods:" },
                )
            }

            forEach(perioder) { periode ->
                includePhrase(TabellPeriode(periode))
            }
        }
    }
}
----

=== Fraser med tilgang til rot-modellen

Hvis en frase trenger tilgang til hele datamodellen, bruk `OutlineOnlyScope` med modell-type:

[source,kotlin]
----
@TemplateModelHelpers
data class UforetrygdOppsummering<Lang : LanguageSupport>(
    // Frasen får tilgang til hele modellen
) : OutlinePhrase<Lang, UforetrygdDto>() {
    override fun OutlineOnlyScope<Lang, UforetrygdDto>.template() {
        paragraph {
            text(
                bokmal {
                    +"Du har "
                    +uforegrad.format()  // Tilgang via @TemplateModelHelpers
                    +" prosent uføregrad"
                }
            )
        }
    }
}
----

=== Organisering av fraser

Organiser fraser i logiske grupper:

[source]
----
fraser/
├── common/
│   ├── Felles.kt              # Generiske fraser brukt på tvers
│   ├── Lovhenvisninger.kt     # Standardreferanser til lover
│   └── KontaktInfo.kt         # Kontaktinformasjon
├── uforetrygd/
│   ├── BeregningFraser.kt     # Beregningsforklaringer
│   ├── VilkaarFraser.kt       # Vilkårsbeskrivelser
│   └── MeldepliktFraser.kt    # Meldeplikt-informasjon
└── barnetillegg/
    ├── BeregningFraser.kt     # Barnetillegg-beregning
    └── VilkaarFraser.kt       # Barnetillegg-vilkår
----

Eksempel på `Felles.kt`:

[source,kotlin]
----
object Felles {
    object RettTilAKlage : OutlinePhrase<LangBokmalNynorskEnglish>() { ... }
    object HarDuSporsmal : OutlinePhrase<LangBokmalNynorskEnglish>() { ... }

    data class MeldFraOmEndringer(
        val inkluderInntekt: Expression<Boolean> = true.expr(),
        val inkluderSivilstand: Expression<Boolean> = true.expr()
    ) : OutlinePhrase<LangBokmalNynorskEnglish>() { ... }
}
----

[[vedlegg]]
== Vedlegg

Vedlegg er separate dokumenter som følger brevet. De har egen tittel og innhold, og kan inkluderes betinget.

=== Definere et vedlegg

[source,kotlin]
----
@TemplateModelHelpers
val beregningDetaljer = createAttachment<LangBokmalNynorskEnglish, BeregningDto>(
    title = newText(
        bokmal { +"Beregning av uføretrygd" },
        nynorsk { +"Utrekning av uføretrygd" },
        english { +"Calculation of disability benefit" }
    ),
    includeSakspart = false,  // Vis brukerinfo på vedlegget?
) {
    // Vedleggsinnhold - samme DSL som outline
    paragraph {
        text(
            bokmal { +"Her finner du detaljert beregning av uføretrygden din." },
            nynorsk { +"Her finn du detaljert utrekning av uføretrygda di." },
            english { +"Here you will find a detailed calculation of your disability benefit." },
        )
    }

    title1 {
        text(
            bokmal { +"Grunnlag for beregning" },
            nynorsk { +"Grunnlag for utrekning" },
            english { +"Basis for calculation" },
        )
    }

    paragraph {
        table(
            header = {
                column { text(bokmal { +"Type" }, FontType.BOLD) }
                column(alignment = ColumnAlignment.RIGHT) {
                    text(bokmal { +"Beløp" }, FontType.BOLD)
                }
            }
        ) {
            row {
                cell { text(bokmal { +"Grunnbeløp" }) }
                cell { eval(grunnbeloep.format()) }
            }
            row {
                cell { text(bokmal { +"Uføregrad" }) }
                cell { eval(uforegrad.format()) }
            }
            row {
                cell { text(bokmal { +"Totalt per måned" }) }
                cell { eval(maanedligBeloep.format()) }
            }
        }
    }
}
----

=== Inkludere vedlegg

==== Fast vedlegg

Vedlegget inkluderes alltid:

[source,kotlin]
----
@TemplateModelHelpers
object MittBrev : AutobrevTemplate<MittBrevDto> {
    override val template = createTemplate(...) {
        title { ... }
        outline { ... }

        // Vedlegget inkluderes alltid
        includeAttachment(beregningDetaljer, beregningsdata)
    }
}
----

==== Betinget vedlegg med predicate

Vedlegget inkluderes kun hvis predicate er true:

[source,kotlin]
----
includeAttachment(
    template = beregningDetaljer,
    attachmentData = beregningsdata,
    predicate = harKompleksBeregning  // Expression<Boolean>
)
----

==== Betinget vedlegg basert på nullable data

Vedlegget inkluderes kun hvis data finnes:

[source,kotlin]
----
// Hvis beregningsdata er null, inkluderes ikke vedlegget
includeAttachmentIfNotNull(
    template = beregningDetaljer,
    attachmentData = beregningsdata  // BeregningDto?
)
----

=== includeSakspart

`includeSakspart` parameteren styrer om brukerinformasjon vises på vedlegget:

[source,kotlin]
----
// Med brukerinfo (navn, fødselsnummer, saksnummer)
val vedleggMedSakspart = createAttachment<...>(
    title = ...,
    includeSakspart = true,  // Vis brukerinfo
) { ... }

// Uten brukerinfo (kun tittelen)
val vedleggUtenSakspart = createAttachment<...>(
    title = ...,
    includeSakspart = false,  // Skjul brukerinfo
) { ... }
----

=== Vedlegg med kompleks logikk

Vedlegg kan inneholde all samme logikk som hovedbrevet:

[source,kotlin]
----
@TemplateModelHelpers
val trygdetidsVedlegg = createAttachment<LangBokmalNynorskEnglish, TrygdetidDto>(
    title = newText(
        bokmal { +"Din trygdetid" },
        nynorsk { +"Trygdetida di" },
        english { +"Your insurance period" }
    ),
    includeSakspart = false,
) {
    paragraph {
        text(
            bokmal { +"Vi har registrert følgende trygdetid:" },
            nynorsk { +"Vi har registrert følgjande trygdetid:" },
            english { +"We have registered the following insurance period:" },
        )
    }

    showIf(trygdetidNorge.isNotEmpty()) {
        title2 {
            text(
                bokmal { +"Trygdetid i Norge" },
                nynorsk { +"Trygdetid i Noreg" },
                english { +"Insurance period in Norway" },
            )
        }

        paragraph {
            table(
                header = {
                    column { text(bokmal { +"Fra dato" }, FontType.BOLD) }
                    column { text(bokmal { +"Til dato" }, FontType.BOLD) }
                    column(alignment = ColumnAlignment.RIGHT) {
                        text(bokmal { +"År" }, FontType.BOLD)
                    }
                }
            ) {
                forEach(trygdetidNorge) { periode ->
                    row {
                        cell { eval(periode.fom.format()) }
                        cell { eval(periode.tom.format()) }
                        cell { eval(periode.aar.format()) }
                    }
                }
            }
        }
    }

    ifNotNull(trygdetidUtland) { utland ->
        title2 {
            text(
                bokmal { +"Trygdetid i utlandet" },
                nynorsk { +"Trygdetid i utlandet" },
                english { +"Insurance period abroad" },
            )
        }

        forEach(utland) { periode ->
            paragraph {
                text(
                    bokmal {
                        +periode.land
                        +": "
                        +periode.aar.format()
                        +" år"
                    }
                )
            }
        }
    }
}
----

=== Organisering av vedlegg

Plasser vedlegg i `vedlegg/` pakken:

[source]
----
maler/
├── MittBrev.kt
├── fraser/
│   └── ...
└── vedlegg/
    ├── BeregningDetaljer.kt
    ├── TrygdetidOversikt.kt
    └── DineRettigheter.kt
----

== Komplekse logikkmønstre

=== Kjeding av betingelser

For kompleks if/elseif/else logikk:

[source,kotlin]
----
showIf(uforegrad.greaterThanOrEqual(80)) {
    paragraph {
        text(bokmal { +"Du har svært høy uføregrad." })
    }
}.orShowIf(uforegrad.greaterThanOrEqual(50)) {
    paragraph {
        text(bokmal { +"Du har høy uføregrad." })
    }
}.orShowIf(uforegrad.greaterThanOrEqual(20)) {
    paragraph {
        text(bokmal { +"Du har moderat uføregrad." })
    }
}.orShow {
    paragraph {
        text(bokmal { +"Du har lav uføregrad." })
    }
}
----

=== Kombinere multiple nullable verdier

[source,kotlin]
----
// Alle må være satt
ifNotNull(verdi1, verdi2, verdi3) { v1, v2, v3 ->
    paragraph {
        text(bokmal { +v1 + ", " + v2 + " og " + v3 })
    }
}

// Med fallback
ifNotNull(primærVerdi) { verdi ->
    text(bokmal { +"Primær: " + verdi })
}.orIfNotNull(sekundærVerdi) { verdi ->
    text(bokmal { +"Sekundær: " + verdi })
}.orShow {
    text(bokmal { +"Ingen verdi tilgjengelig" })
}
----

=== Betinget innhold i forEach

[source,kotlin]
----
forEach(perioder) { periode ->
    // Kun vis perioder som er aktive
    showIf(periode.aktiv) {
        row {
            cell { eval(periode.fom.format()) }
            cell { eval(periode.tom.format()) }

            // Betinget celle
            showIf(periode.harMerknad) {
                cell { eval(periode.merknad) }
            }.orShow {
                cell { text(bokmal { +"-" }) }
            }
        }
    }
}
----

=== Nøstede forEach

[source,kotlin]
----
forEach(ytelser) { ytelse ->
    title2 {
        text(bokmal { +ytelse.navn })
    }

    paragraph {
        table(
            header = {
                column { text(bokmal { +"Måned" }, FontType.BOLD) }
                column(alignment = ColumnAlignment.RIGHT) {
                    text(bokmal { +"Beløp" }, FontType.BOLD)
                }
            }
        ) {
            forEach(ytelse.utbetalinger) { utbetaling ->
                row {
                    cell { eval(utbetaling.maaned.format()) }
                    cell { eval(utbetaling.beloep.format()) }
                }
            }
        }
    }
}
----

=== Komplekse boolske uttrykk

[source,kotlin]
----
val erGift = sivilstand.isOneOf(Sivilstand.GIFT, Sivilstand.REGISTRERT_PARTNER)
val harInntekt = inntekt.greaterThan(0.expr())
val borMedEktefelle = borsammen.equalTo(true.expr())

val ektefelleRedusererYtelse = erGift and harInntekt and borMedEktefelle

showIf(ektefelleRedusererYtelse) {
    paragraph {
        text(
            bokmal { +"Ektefellens inntekt påvirker ytelsen din." },
            nynorsk { +"Ektefellen si inntekt påverkar ytinga di." },
        )
    }
}
----

== Map og filter på samlinger

=== Map - transformer elementer

[source,kotlin]
----
val barn = barnetilleggBarn.map { it.navn }

forEach(barn) { navn ->
    item {
        text(bokmal { +navn })
    }
}
----

=== Filter - filtrer elementer

[source,kotlin]
----
val aktivePerioder = perioder.filter { it.aktiv }

showIf(aktivePerioder.isNotEmpty()) {
    paragraph {
        text(bokmal { +"Du har aktive perioder:" })
    }

    forEach(aktivePerioder) { periode ->
        paragraph {
            text(bokmal { +periode.beskrivelse })
        }
    }
}
----

=== Kombinere map og filter

[source,kotlin]
----
val aktiveBeloep = perioder
    .filter { it.aktiv }
    .map { it.beloep }

ifNotNull(aktiveBeloep.size().greaterThan(0)) {
    paragraph {
        text(
            bokmal {
                +"Du har "
                +aktiveBeloep.size().format()
                +" aktive utbetalinger."
            }
        )
    }
}
----

== Avanserte tekst-patterns

=== Dynamisk grammatikk (entall/flertall)

[source,kotlin]
----
val antallBarn = barn.size()
val barneEllerBarn = ifElse(antallBarn.equalTo(1), "barn", "barna")

text(
    bokmal {
        +"Barnetillegget gjelder "
        +barneEllerBarn
        +" som bor sammen med begge foreldre."
    }
)
----

=== Lister med komma-separering

For å liste elementer med komma og "og":

[source,kotlin]
----
// For enkle lister, bruk list { }
list {
    forEach(barn) { barn ->
        item {
            text(bokmal { +barn.navn })
        }
    }
}

// For inline-lister (mer komplekst, ofte bedre å bruke list { })
// Dette må bygges opp manuelt med logikk
----

== Dynamiske tabeller

=== Tabell med variabelt antall kolonner

[source,kotlin]
----
paragraph {
    table(
        header = {
            column { text(bokmal { +"Beskrivelse" }, FontType.BOLD) }
            column(alignment = ColumnAlignment.RIGHT) {
                text(bokmal { +"Beløp" }, FontType.BOLD)
            }

            // Betinget kolonne
            showIf(visSkattekolonne) {
                column(alignment = ColumnAlignment.RIGHT) {
                    text(bokmal { +"Skatt" }, FontType.BOLD)
                }
            }
        }
    ) {
        forEach(perioder) { periode ->
            row {
                cell { eval(periode.beskrivelse) }
                cell { eval(periode.beloep.format()) }

                // Må matche header
                showIf(visSkattekolonne) {
                    cell { eval(periode.skatt.format()) }
                }
            }
        }
    }
}
----

IMPORTANT: Antall celler i hver rad må alltid matche antall kolonner i header, ellers feiler malen ved oppstart.

== Testing av avansert logikk

=== Test komplekse betingelser

[source,kotlin]
----
@Test
fun `test alle kombinasjoner av betingelser`() {
    // Test alle fire kombinasjoner
    testBrev(erGift = true, harInntekt = true)
    testBrev(erGift = true, harInntekt = false)
    testBrev(erGift = false, harInntekt = true)
    testBrev(erGift = false, harInntekt = false)
}
----

=== Test forEach med ulike størrelser

[source,kotlin]
----
@Test
fun `test med tom liste`() {
    val dto = createDto(perioder = emptyList())
    val result = render(dto)
    // Verifiser at tom liste håndteres korrekt
}

@Test
fun `test med ett element`() {
    val dto = createDto(perioder = listOf(periode1))
    val result = render(dto)
    // Verifiser grammatikk (entall)
}

@Test
fun `test med flere elementer`() {
    val dto = createDto(perioder = listOf(periode1, periode2, periode3))
    val result = render(dto)
    // Verifiser grammatikk (flertall)
}
----

=== Test fraser isolert

[source,kotlin]
----
@Test
fun `test frase med parametere`() {
    val phrase = BeregningsDetaljer(
        harFlerePerioder = true.expr(),
        perioder = listOf(periode1, periode2).expr(),
        gjeldendePeriode = periode1.expr()
    )

    // Render frasen direkte for testing
    val result = renderPhrase(phrase, Bokmal)

    assertThat(result).contains("flere beregningsperioder")
}
----

== Ytterligere ressurser

* xref:brevbaker-dsl-referanse.adoc[DSL Referanse] - Komplett oversikt
* xref:brevbaker-dsl-guide.adoc[Utviklingsguide] - Grunnleggende eksempler
* xref:brevbaker-dsl-beste-praksis.adoc[Beste praksis] - Anbefalinger

