:docinfo: shared
:source-highlighter: highlight.js
:toc:

= Brevmal-DSL: Utviklingsguide

Denne guiden tar deg gjennom prosessen for å lage en ny brevmal.

== Steg 1: Opprette en ny brevmal

=== 1.1 Opprett Dto(data-klasse) for brevet i API-modellen

Først må du definere dataklassen som beskriver informasjonsbehovet til malen.

I api-model prosjektet, opprett en ny data-klasse:

[source,kotlin]
----
// I f.eks pensjon/brevbaker/api/model/maler/
data class MittBrevDto(
    val uforegrad: Int,
    val virkningFom: LocalDate,
    val maanedligBeloep: Kroner,
    val harBarnetillegg: Boolean,
    val barnetilleggBarn: List<Barn> = emptyList()
) {
    data class Barn(
        val navn: String,
        val fodselsdato: LocalDate
    )
}
----

TIP: Tenk nøye gjennom nullability. Hvis barnetillegg kun er relevant når `harBarnetillegg` er true, vurder å gruppere relaterte felter i en nøstet dataklasse.

=== 1.2 Legg til brevkode

I api-model, legg til brevkoden i relevant enum-klasse (for de fleste er dette `Pesysbrevkoder.kt`):

[source,kotlin]
----
enum class AutoBrev(override val redigerbart: Boolean) : Brevkode {
    // ... eksisterende koder ...
    PE_MITT_BREV(false),
}
----

=== 1.3 Publiser API-modellen midlertidig

For å kunne bruke de nye typene i brevbakeren:

[source,bash]
----
# I api-model mappen
./gradlew publishToMavenLocal
----

Oppdater `apiModelVersion` i `gradle.properties` i brevbaker-prosjektet.

=== 1.4 Opprett malfilen

Opprett en ny fil under passende pakke i brevbaker:

[source,kotlin]
----
// brevbaker/maler/src/main/kotlin/no/nav/pensjon/brev/maler/MittBrev.kt
@TemplateModelHelpers
object MittBrev : AutobrevTemplate<MittBrevDto> {

    override val kode = Pesysbrevkoder.AutoBrev.PE_MITT_BREV

    override val template = createTemplate(
        name = kode.name,
        letterDataType = MittBrevDto::class,
        languages = languages(Bokmal, Nynorsk, English),
        letterMetadata = LetterMetadata(
            displayTitle = "Vedtak om uføretrygd",
            distribusjonstype = LetterMetadata.Distribusjonstype.VEDTAK,
            brevtype = LetterMetadata.Brevtype.VEDTAKSBREV,
        )
    ) {
        title {
            text(
                bokmal { +"Vedtak om uføretrygd" },
                nynorsk { +"Vedtak om uføretrygd" },
                english { +"Decision on disability benefit" },
            )
        }

        outline {
            // Innhold kommer her
        }
    }
}
----

== Steg 2: Legge til innhold

=== 2.1 Enkelt avsnitt med tekst

Start med et enkelt avsnitt:

[source,kotlin]
----
outline {
    paragraph {
        text(
            bokmal { +"Vi har behandlet søknaden din om uføretrygd." },
            nynorsk { +"Vi har behandla søknaden din om uføretrygd." },
            english { +"We have processed your application for disability benefit." },
        )
    }
}
----

=== 2.2 Tekst med variabler

Legg til dynamisk innhold fra datamodellen:

[source,kotlin]
----
outline {
    paragraph {
        text(
            bokmal {
                +"Fra "
                +virkningFom.format()
                +" får du "
                +uforegrad.format()
                +" prosent uføretrygd."
            },
            nynorsk {
                +"Frå "
                +virkningFom.format()
                +" får du "
                +uforegrad.format()
                +" prosent uføretrygd."
            },
            english {
                +"From "
                +virkningFom.format()
                +" you will receive "
                +uforegrad.format()
                +" percent disability benefit."
            },
        )
    }
}
----

NOTE: `virkningFom` og `uforegrad` er tilgjengelig direkte takket være `@TemplateModelHelpers`.

=== 2.3 Overskrifter og struktur

Legg til overskrifter for å strukturere innholdet:

[source,kotlin]
----
outline {
    title1 {
        text(
            bokmal { +"Dette får du utbetalt" },
            nynorsk { +"Dette får du utbetalt" },
            english { +"Your payment" },
        )
    }

    paragraph {
        text(
            bokmal {
                +"Du får utbetalt "
                +maanedligBeloep.format()
                +" kroner per måned før skatt."
            },
            nynorsk {
                +"Du får utbetalt "
                +maanedligBeloep.format()
                +" kroner per månad før skatt."
            },
            english {
                +"You will receive "
                +maanedligBeloep.format()
                +" kroner per month before tax."
            },
        )
    }
}
----

== Steg 3: Legge til logikk

=== 3.1 Enkel betingelse med showIf

Vis innhold kun dersom en betingelse er oppfylt:

[source,kotlin]
----
outline {
    // ... tidligere innhold ...

    showIf(harBarnetillegg) {
        title2 {
            text(
                bokmal { +"Barnetillegg" },
                nynorsk { +"Barnetillegg" },
                english { +"Child supplement" },
            )
        }

        paragraph {
            text(
                bokmal { +"Du får barnetillegg fordi du har barn under 18 år." },
                nynorsk { +"Du får barnetillegg fordi du har barn under 18 år." },
                english { +"You receive a child supplement because you have children under 18." },
            )
        }
    }
}
----

=== 3.2 If/else med orShow

Vis forskjellig innhold basert på betingelser:

[source,kotlin]
----
showIf(uforegrad.greaterThanOrEqual(50)) {
    paragraph {
        text(
            bokmal { +"Du har høy uføregrad og får derfor full uføretrygd." },
            nynorsk { +"Du har høg uføregrad og får difor full uføretrygd." },
            english { +"You have a high disability rating and therefore receive full disability benefit." },
        )
    }
}.orShow {
    paragraph {
        text(
            bokmal { +"Du har delvis uføregrad og får gradert uføretrygd." },
            nynorsk { +"Du har delvis uføregrad og får gradert uføretrygd." },
            english { +"You have a partial disability rating and receive graded disability benefit." },
        )
    }
}
----

=== 3.3 Null-sikker visning med ifNotNull

Håndter nullable verdier trygt:

[source,kotlin]
----
ifNotNull(barnetilleggBarn) { barn ->
    paragraph {
        text(
            bokmal { +"Barnetillegget gjelder for følgende barn:" },
            nynorsk { +"Barnetillegget gjeld for følgjande barn:" },
            english { +"The child supplement applies to the following children:" },
        )

        list {
            forEach(barn) { enkeltBarn ->
                item {
                    text(
                        bokmal {
                            +enkeltBarn.navn
                            +" (født "
                            +enkeltBarn.fodselsdato.format()
                            +")"
                        },
                        nynorsk {
                            +enkeltBarn.navn
                            +" (fødd "
                            +enkeltBarn.fodselsdato.format()
                            +")"
                        },
                        english {
                            +enkeltBarn.navn
                            +" (born "
                            +enkeltBarn.fodselsdato.format()
                            +")"
                        },
                    )
                }
            }
        }
    }
}
----

== Steg 4: Lister og tabeller

=== 4.1 Punktliste

[source,kotlin]
----
paragraph {
    text(
        bokmal { +"For å beholde uføretrygden må du:" },
        nynorsk { +"For å behalde uføretrygda må du:" },
        english { +"To keep your disability benefit you must:" },
    )

    list {
        item {
            text(
                bokmal { +"Melde fra om endringer i inntekt" },
                nynorsk { +"Melde frå om endringar i inntekt" },
                english { +"Report changes in income" },
            )
        }
        item {
            text(
                bokmal { +"Melde fra om endringer i sivilstand" },
                nynorsk { +"Melde frå om endringar i sivilstand" },
                english { +"Report changes in marital status" },
            )
        }
        item {
            text(
                bokmal { +"Melde fra hvis du flytter til utlandet" },
                nynorsk { +"Melde frå dersom du flyttar til utlandet" },
                english { +"Report if you move abroad" },
            )
        }
    }
}
----

=== 4.2 Tabell med fast innhold

[source,kotlin]
----
paragraph {
    table(
        header = {
            column(columnSpan = 2) {
                text(bokmal { +"Type ytelse" }, FontType.BOLD)
            }
            column(alignment = ColumnAlignment.RIGHT) {
                text(bokmal { +"Beløp per måned" }, FontType.BOLD)
            }
        }
    ) {
        row {
            cell {
                text(bokmal { +"Uføretrygd" })
            }
            cell {
                eval(maanedligBeloep.format())
            }
        }

        showIf(harBarnetillegg) {
            row {
                cell {
                    text(bokmal { +"Barnetillegg" })
                }
                cell {
                    text(bokmal { +"1 500 kr" })
                }
            }
        }
    }
}
----

== Steg 5: Bruke fraser

=== 5.1 Definere en frase

Opprett en gjenbrukbar frase i egen fil:

[source,kotlin]
----
// fraser/UtbetalingsinfoFrase.kt

data class UtbetalingsInfo(
    val beloep: Expression<Kroner>,
    val utbetalingsdato: Expression<Int>
) : OutlinePhrase<LangBokmalNynorskEnglish>() {
    override fun OutlineOnlyScope<LangBokmalNynorskEnglish, Unit>.template() {
        paragraph {
            text(
                bokmal {
                    +"Du får utbetalt "
                    +beloep.format()
                    +" kroner den "
                    +utbetalingsdato.format()
                    +". hver måned."
                },
                nynorsk {
                    +"Du får utbetalt "
                    +beloep.format()
                    +" kroner den "
                    +utbetalingsdato.format()
                    +". kvar månad."
                },
                english {
                    +"You will receive "
                    +beloep.format()
                    +" kroner on the "
                    +utbetalingsdato.format()
                    +" of each month."
                },
            )
        }
    }
}
----

=== 5.2 Bruke frasen

[source,kotlin]
----
outline {
    includePhrase(UtbetalingsInfo(
        beloep = maanedligBeloep,
        utbetalingsdato = 20.expr()
    ))
}
----

== Steg 6: Legge til vedlegg

=== 6.1 Definere vedlegg

[source,kotlin]
----
// vedlegg/BeregningDetaljer.kt

@TemplateModelHelpers
val beregningDetaljer = createAttachment<LangBokmalNynorskEnglish, BeregningDto>(
    title = newText(
        bokmal { +"Beregning av uføretrygd" },
        nynorsk { +"Utrekning av uføretrygd" },
        english { +"Calculation of disability benefit" }
    ),
    includeSakspart = false,
) {
    paragraph {
        text(
            bokmal { +"Her finner du detaljert beregning av uføretrygden din." },
            nynorsk { +"Her finn du detaljert utrekning av uføretrygda di." },
            english { +"Here you will find a detailed calculation of your disability benefit." },
        )
    }

    // ... mer innhold ...
}
----

=== 6.2 Inkludere vedlegg i brevet

[source,kotlin]
----
@TemplateModelHelpers
object MittBrev : AutobrevTemplate<MittBrevDto> {
    // ... template setup ...

    override val template = createTemplate(...) {
        title { ... }
        outline { ... }

        // Fast vedlegg
        includeAttachment(beregningDetaljer, beregningsdata)

        // Betinget vedlegg (kun hvis data finnes)
        includeAttachmentIfNotNull(ekstraDetaljer, ekstraData)
    }
}
----

== Steg 7: Testing

=== 7.1 Opprette en test

[source,kotlin]
----
// test/kotlin/no/nav/pensjon/brev/maler/MittBrevTest.kt
class MittBrevTest {

    @Test
    fun `test brev uten barnetillegg`() {
        val dto = MittBrevDto(
            uforegrad = 100,
            virkningFom = LocalDate.of(2025, 1, 1),
            maanedligBeloep = Kroner(15000),
            harBarnetillegg = false,
            barnetilleggBarn = null
        )

        MittBrev.render(dto, Bokmal).let { result ->
            assertThat(result).contains("100 prosent uføretrygd")
            assertThat(result).doesNotContain("Barnetillegg")
        }
    }

    @Test
    fun `test brev med barnetillegg`() {
        val dto = MittBrevDto(
            uforegrad = 100,
            virkningFom = LocalDate.of(2025, 1, 1),
            maanedligBeloep = Kroner(15000),
            harBarnetillegg = true,
            barnetilleggBarn = listOf(
                MittBrevDto.Barn("Ola Nordmann", LocalDate.of(2015, 5, 17))
            )
        )

        MittBrev.render(dto, Bokmal).let { result ->
            assertThat(result).contains("Barnetillegg")
            assertThat(result).contains("Ola Nordmann")
        }
    }
}
----

=== 7.2 Kjøre tester

[source,bash]
----
./gradlew test
----

== Steg 8: Best practices

=== 8.1 Organiser koden

* Hold maler korte (under 300 linjer)
* Bryt ut gjenbrukbart innhold i fraser
* Grupper relaterte fraser i egne filer
* Bruk beskrivende variabelnavn

=== 8.2 Datamodell

* Tenk nøye gjennom nullability
* Grupper relaterte felter i nøstede dataklasser
* Bruk non-nullable for påkrevde verdier
* Dokument datamodellen med KDoc-kommentarer

=== 8.3 Oversettelser

* Få oversettelser gjennomgått av språkeksperter
* Konsistente termer på tvers av brev
* Husk at engelske fraser kan ha annen struktur

=== 8.4 Testing

* Test alle betingelser (if/else-grener)
* Test med og uten nullable verdier
* Test med tomme og ikke-tomme lister
* Test alle språkvarianter

== Komplett eksempel

Her er et komplett eksempel som viser mange av konseptene:

[source,kotlin]
----
@TemplateModelHelpers
object UforetrygdVedtak : AutobrevTemplate<UforetrygdVedtakDto> {

    override val kode = Pesysbrevkoder.AutoBrev.PE_UFORETRYGD_VEDTAK

    override val template = createTemplate(
        name = kode.name,
        letterDataType = UforetrygdVedtakDto::class,
        languages = languages(Bokmal, Nynorsk),
        letterMetadata = LetterMetadata(
            displayTitle = "Vedtak om uføretrygd",
            distribusjonstype = LetterMetadata.Distribusjonstype.VEDTAK,
            brevtype = LetterMetadata.Brevtype.VEDTAKSBREV,
        )
    ) {
        title {
            text(
                bokmal { +"Vedtak om uføretrygd" },
                nynorsk { +"Vedtak om uføretrygd" },
            )
        }

        outline {
            paragraph {
                text(
                    bokmal {
                        +"Vi har behandlet søknaden din om uføretrygd. Fra "
                        +virkningFom.format()
                        +" får du "
                        +uforegrad.format()
                        +" prosent uføretrygd."
                    },
                    nynorsk {
                        +"Vi har behandla søknaden din om uføretrygd. Frå "
                        +virkningFom.format()
                        +" får du "
                        +uforegrad.format()
                        +" prosent uføretrygd."
                    },
                )
            }

            title1 {
                text(
                    bokmal { +"Dette får du utbetalt" },
                    nynorsk { +"Dette får du utbetalt" },
                )
            }

            paragraph {
                text(
                    bokmal {
                        +"Du får utbetalt "
                        +maanedligBeloep.format()
                        +" kroner per måned før skatt."
                    },
                    nynorsk {
                        +"Du får utbetalt "
                        +maanedligBeloep.format()
                        +" kroner per månad før skatt."
                    },
                )
            }

            showIf(harBarnetillegg) {
                paragraph {
                    text(
                        bokmal { +"I tillegg får du barnetillegg." },
                        nynorsk { +"I tillegg får du barnetillegg." },
                    )
                }
            }

            title1 {
                text(
                    bokmal { +"Dine plikter" },
                    nynorsk { +"Pliktene dine" },
                )
            }

            includePhrase(Felles.MeldFraOmEndringer)
            includePhrase(Felles.RettTilAKlage)
        }

        includeAttachment(beregningDetaljer, beregningsdata)
    }
}
----

== Neste steg

* Les xref:brevbaker-dsl-beste-praksis.adoc[Beste praksis] for anbefalte mønstre
* Se xref:brevbaker-dsl-avansert.adoc[Avanserte emner] for komplekse scenarier
* Studer eksisterende maler i `pensjon/maler/` for inspirasjon

