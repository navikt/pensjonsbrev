:docinfo: shared
:source-highlighter: highlight.js
:toc:

= Brevmal-DSL: Oversikt

== Hva er brevmal-DSL?

Brevmal-DSL er et Kotlin-basert domenespesifikt språk (Domain Specific Language) for å definere brevmaler i NAV. DSL-en er utviklet for å kun inneholde de elementene vi trenger for å representere innholdet i brev.

== Nøkkelegenskaper

**Typesikkerhet**::
Kotlin-kompilatoren verifiserer at malen er korrekt. Feil oppdages ved kompilering, ikke i produksjon.

**Null-safety**::
Det er ikke mulig å bruke nullable inndata på en måte hvor man risikerer NPE eller at teksten "null" havner i produserte brev.

**Flerspråklighet**::
Innebygd støtte for bokmål, nynorsk og engelsk. Kompilatoren sikrer at alle påkrevde språk har oversettelser.

**Expression-basert**::
Dynamiske verdier brukes via `Expression<T>`-systemet. Dette sikrer at logikk evalueres ved brevgenerering, ikke ved oppstart.

**Gjenbruk**::
Fraser (`Phrase`) kan deles mellom maler for konsistent innhold og enklere vedlikehold.

**Begrenset funksjonalitet**::
Vi har bevisst utelatt funksjonalitet som ikke direkte har med visningslogikk å gjøre, f.eks. aritmetiske operasjoner for tall. Dette gjør det mindre sannsynlig at man implementerer tekniske feil i maler.

== Designfilosofi

=== Informasjonsmodellen er viktig

Informasjonsmodellen bør ta hensyn til virkelighetsbildet når det gjelder hvordan data er knyttet sammen og nullability:

* Om det ikke gir mening å ha verdi A uten verdi B, så bør disse grupperes sammen (i en nøstet data-klasse)
* Om brevet krever en verdi C, så bør den være non-nullable slik at brevproduksjonen kan feile allerede der hvor man populerer opp informasjonsmodellen

=== Logikk hører hjemme utenfor malen

Forretningslogikk og beregninger skal i størst mulig grad foregå utenfor brevmalen. Malen skal primært håndtere:

* Visningslogikk (hva skal vises når)
* Formatering av data
* Strukturering av innhold

== Maltyper

Det finnes to hovedtyper brevmaler:

[cols="1,2,3"]
|===
|Type |Interface |Beskrivelse

|Automatisk brev
|`AutobrevTemplate<Dto>`
|Sendes automatisk uten redigering. Innholdet bestemmes helt av dataene som sendes inn.

|Redigerbart brev
|`RedigerbarTemplate<Dto>`
|Kan redigeres av saksbehandler før sending. Kan inneholde skjemafelt som fylles ut manuelt.
|===

== Dokumenthierarki

Et brev er bygget opp av følgende hovedelementer:

[plantuml, format=svg]
----
@startuml
skinparam component {
  BackgroundColor LightBlue
  BorderColor Navy
}

package "Brev" {
  [Tittel]
  [Outline] as outline
  [Vedlegg] as vedlegg
}

package "Outline" {
  [title1]
  [title2]
  [title3]
  [paragraph] as para
}

package "Paragraph" {
  [text]
  [list]
  [table]
  [formText]
  [formChoice]
}

outline --> para
para --> text
para --> list
para --> table

@enduml
----

**Tittel**:: Brevets hovedtittel (påkrevd)
**Outline**:: Hovedinnholdet i brevet med overskrifter og avsnitt
**Vedlegg**:: Separate dokumenter som følger brevet

== Språkstøtte

Brevmaler kan støtte ett eller flere språk:

[source,kotlin]
----
// Kun bokmål
languages(Bokmal)

// Bokmål og nynorsk
languages(Bokmal, Nynorsk)

// Alle tre språk
languages(Bokmal, Nynorsk, English)
----

Kompilatoren vil gi feil hvis du mangler oversettelser for språk som er definert i malen.

== Grunnleggende malstruktur

En minimal brevmal ser slik ut:

[source,kotlin]
----
@TemplateModelHelpers  // <1>
object MittBrev : AutobrevTemplate<MittBrevDto> {  // <2>

    override val kode = Pesysbrevkoder.AutoBrev.MITT_BREV  // <3>

    override val template = createTemplate(
        name = kode.name,
        letterDataType = MittBrevDto::class,  // <4>
        languages = languages(Bokmal, Nynorsk),  // <5>
        letterMetadata = LetterMetadata(
            displayTitle = "Mitt vedtaksbrev",
            distribusjonstype = LetterMetadata.Distribusjonstype.VEDTAK,
            brevtype = LetterMetadata.Brevtype.VEDTAKSBREV,
        )
    ) {
        title {  // <6>
            text(
                bokmal { +"Tittel på brevet" },
                nynorsk { +"Tittel på brevet" },
            )
        }

        outline {  // <7>
            paragraph {
                text(
                    bokmal { +"Dette er innholdet i brevet." },
                    nynorsk { +"Dette er innhaldet i brevet." },
                )
            }
        }
    }
}
----
<1> Annotasjon som genererer selector-extensions for DTO-en
<2> Maltypen (AutobrevTemplate eller RedigerbarTemplate)
<3> Brevkode som identifiserer brevet i systemet
<4> Data-klassen som definerer informasjonsbehovet
<5> Hvilke språk malen støtter
<6> Brevets hovedtittel
<7> Hovedinnholdet i brevet

== Videre lesning

* xref:brevbaker-dsl-referanse.adoc[DSL Referanse] - Komplett oversikt over alle DSL-elementer
* xref:brevbaker-dsl-guide.adoc[Utviklingsguide] - Steg-for-steg guide til utvikling av maler
* xref:brevbaker-dsl-beste-praksis.adoc[Beste praksis] - Anbefalte mønstre og anti-patterns
* xref:brevbaker-dsl-avansert.adoc[Avanserte emner] - Fraser, vedlegg og kompleks logikk

