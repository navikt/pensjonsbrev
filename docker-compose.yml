#Used for local testing purposes
version: '3.8'
services:
  pdf-bygger:
    build: ./pdf-bygger
    environment:
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006 -Djdk.lang.Process.launchMechanism=vfork #used for Apple M1 compatability
      - PDF_COMPILE_TIMEOUT_SECONDS=200
      - PDF_BYGGER_COMPILE_TMP_DIR=/tmp
    ports:
      - "8081:8080"
      - "5016:5006"
  pensjon-brevbaker:
    environment:
      - PDF_BUILDER_URL=http://pdf-bygger:8080
      - AZURE_OPENID_CONFIG_JWKS_URI=http://vtp-pensjon:8060/rest/isso/oauth2/connect/jwk_uri
      - AZURE_OPENID_CONFIG_ISSUER=https://login.microsoftonline.com/966ac572-f5b7-4bbe-aa88-c76419c0f851/v2.0
      - AZURE_APP_CLIENT_ID=brevbaker-123
      - AZURE_APP_PRE_AUTHORIZED_APPS=[{"name":"pen","clientId":"pen-AzureClientId"}]
      # Allows requests without auth-header #opens up debug port
      - JAVA_TOOL_OPTIONS=-Dio.ktor.development=true -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    build: ./pensjon-brevbaker
    ports:
      - "8080:8080"
      - "5015:5005" # debug port
  skribenten-backend:
    profiles:
      - skribenten
    build: ./skribenten-backend
    depends_on:
      skribenten-backend-db:
          condition: service_started
    ports:
      - "8082:8080"
      - "5017:5007"
    env_file:
      - ./skribenten-backend/secrets/azuread.env
    environment:
      - BREVBAKER_SCOPE=api://dev-gcp.pensjonsbrev.pensjon-brevbaker/.default
      - BREVBAKER_URL=http://pensjon-brevbaker:8080
      - BREVMETADATA_URL=https://pensjon-brevmetadata-q2.intern.dev.nav.no
      - CORS_ALLOW_HOST=*
      - DB_HOST=skribenten-backend-db
      - DB_PORT=5432
      - DB_DATABASE=postgres
      - DB_USERNAME=postgres
      - DB_PASSWORD=pass
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5007
      - KRR_SCOPE=api://dev-gcp.team-rocket.digdir-krr-proxy/.default
      - KRR_URL=https://digdir-krr-proxy.intern.dev.nav.no
      - PDL_SCOPE=api://dev-fss.pdl.pdl-api/.default
      - PDL_URL=https://pdl-api.dev.intern.nav.no/graphql
      - PEN_SCOPE=api://dev-fss.pensjon-q2.pensjon-pen-q2/.default
      - PEN_URL=https://pensjon-pen-q2.dev.adeo.no/pen/springapi/
      - PENSJON_PERSONDATA_SCOPE=api://dev-fss.pensjon-person.pensjon-persondata-q2/.default
      - PENSJON_PERSONDATA_URL=https://pensjon-persondata-q2.dev.intern.nav.no
      - SAF_SCOPE=api://dev-fss.teamdokumenthandtering.saf/.default
      - SAF_URL=https://saf-q2.dev-fss-pub.nais.io/graphql
      - TJENESTEBUSS_INTEGRASJON_URL=http://tjenestebuss-integrasjon:8080
      - TJENESTEBUSS_INTEGRASJON_SCOPE=api://dev-fss.pensjonsbrev.pensjonsbrev-tjenestebuss-lokal/.default
      - NAVANSATT_URL=https://navansatt.dev-fss-pub.nais.io
      - NAVANSATT_SCOPE=api://dev-fss.teampensjon.navansatt/.default
      - GROUPS_PENSJON_UTLAND=bda6bd68-77e6-4c00-96b9-7ecf5df7413c

  skribenten-backend-db:
    profiles:
      - skribenten
    image: 'postgres:14-alpine'
    ports:
      - "5432:5432"
    healthcheck:
      test: [ 'CMD', 'pg_isready', '-U', 'postgres' ]
      interval: 3s
    restart: always
    environment:
      POSTGRES_PASSWORD: pass

  tjenestebuss-integrasjon:
    image: 'tjenestebuss-integrasjon'
    profiles:
      - skribenten
    ports:
      - "8086:8080"
      - "5018:5008"
    env_file:
      - tjenestebuss-integrasjon/secrets/docker.env
    environment:
      - TJENESTEBUSS_URL=https://tjenestebuss-q2.adeo.no/
      - STS_URL=https://security-token-service.dev.adeo.no
      - DOKPROD_URL=https://dokprod-q2.dev.intern.nav.no/
      - BREVKLIENT_ROOTURL=https://wasapp-q2.adeo.no/brevweb/StartBrevKlient.jsp
      - BREVKLIENT_CHROMEROOTURL=https://wasapp-q2.adeo.no/brevweb/
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5008

  wonderwall-skribenten-bff:
    profiles:
      - skribenten
    image: ghcr.io/nais/wonderwall:latest
    platform: linux/amd64
    ports:
      - "8083:8083"
    restart: on-failure
    env_file:
      - skribenten-web/bff/.env
    environment:
      - WONDERWALL_AUTO_LOGIN=true
      - WONDERWALL_OPENID_PROVIDER=azure
      - WONDERWALL_INGRESS=http://localhost:8083
      - WONDERWALL_BIND_ADDRESS=0.0.0.0:8083
      - WONDERWALL_UPSTREAM_HOST=skritenben-bff:8084
      - WONDERWALL_LOG_LEVEL=debug
      - WONDERWALL_LOG_FORMAT=text
  skritenben-bff:
    profiles:
      - skribenten
    build:
      context: skribenten-web/bff
    secrets:
      - npmrc
    env_file:
      - skribenten-web/bff/.env
    ports:
      - "8084:8084"
    environment:
      NODE_ENV: "development"
      EXPRESS_PORT: "8084"
      EXPRESS_HOST: "::"
      SKRIBENTEN_API_URL: "http://skribenten-backend:8080"
      SKRIBENTEN_API_SCOPE: "api://dev-gcp.pensjonsbrev.skribenten-backend-lokal/.default"

  autodokumentasjon:
    profiles:
      - skribenten
    build:
      context: autodokumentasjon-web/bff
    ports:
      - "8088:8088"
    environment:
      NODE_ENV: "development"
      EXPRESS_PORT: "8088"
      EXPRESS_HOST: "::"
      BREVBAKER_API_URL: "http://pensjon-brevbaker:8080"

  locust-master:
    profiles:
      - locust
    image: locustio/locust
    ports:
      - "20080:20080"
      - "8089:8089"
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --master -H https://pensjon-brevbaker.intern.dev.nav.no

  locust-worker:
    deploy:
      replicas: 2
    profiles:
      - locust
    image: locustio/locust
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --worker --master-host locust-master

networks:
  default:
    name: pensjon-local
secrets:
  npmrc:
    file: ~/.npmrc