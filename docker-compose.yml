#Used for local testing purposes
services:
  pdf-bygger:
    build: ./pdf-bygger
    environment:
      - JAVA_OPTS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006 -Djdk.lang.Process.launchMechanism=vfork #used for Apple M1 compatability
      - PDF_COMPILE_TIMEOUT_SECONDS=200
      - PDF_BYGGER_COMPILE_TMP_DIR=/tmp
    ports:
      - "8081:8080"
      - "5016:5006"
  pensjon-brevbaker:
    environment:
      - PDF_BUILDER_URL=http://pdf-bygger:8080
      - AZURE_OPENID_CONFIG_JWKS_URI=http://vtp-pensjon:8060/rest/isso/oauth2/connect/jwk_uri
      - AZURE_OPENID_CONFIG_ISSUER=https://login.microsoftonline.com/966ac572-f5b7-4bbe-aa88-c76419c0f851/v2.0
      - AZURE_APP_CLIENT_ID=brevbaker-123
      - AZURE_APP_PRE_AUTHORIZED_APPS=[{"name":"pen","clientId":"pen-AzureClientId"}]
      # Allows requests without auth-header #opens up debug port
      - JAVA_OPTS=-Dio.ktor.development=true -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    build: ./pensjon-brevbaker
    ports:
      - "8080:8080"
      - "5015:5005" # debug port

  locust-master:
    profiles:
      - locust
    image: locustio/locust
    ports:
      - "20080:20080"
      - "8089:8089"
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --master -H https://pensjon-brevbaker.intern.dev.nav.no

  locust-worker:
    deploy:
      replicas: 2
    profiles:
      - locust
    image: locustio/locust
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --worker --master-host locust-master

networks:
  default:
    name: pensjon-local